<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Abfall-Sprüche-Editor (GitHub JSON + Manifest)</title>

  <link id="fontLink" rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Bebas+Neue:wght@400&display=swap">

  <style>
    @page { size: A3 portrait; margin: 0; }
    *{ -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    :root{
      --bleed: 3mm; --safe: 12mm; --showGuides: 1;
      --font: 'Bebas Neue', Arial, sans-serif; --fontWeight: 400;
      --bg: #ffe98a; --titleBg: #ffd84d; --bubbleBg: #ffcf33;
      --stroke: #000000; --text: #000000;
      --strokeW: 5px; --radius: 14px;
      --cols: 3; --gap: 10mm;
      --titleSize: 24mm;
      --bubbleSize: 8mm;
      --bubbleMin: 5.8mm;
      --letterSpacing: 0.5px;
      --panelW: 410px;
    }
    html, body{ height: 100%; }
    body{
      margin:0; background:#eee;
      display:grid; grid-template-columns: var(--panelW) 1fr;
      gap:16px; padding:16px; box-sizing:border-box;
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    }
    .panel{
      background:#fff; border:1px solid #ddd; border-radius:12px;
      padding:14px; box-shadow:0 8px 20px rgba(0,0,0,.08);
      height:fit-content; position:sticky; top:16px;
    }
    .panel h2{ margin:0 0 10px; font-size:18px; }
    .panel h3{ margin:14px 0 8px; font-size:14px; color:#111; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }
    .rowAuto{ display:grid; grid-template-columns:1fr auto; gap:10px; margin-bottom:8px; align-items:end; }
    label{ font-size:12px; color:#333; display:block; margin-bottom:4px; }
    input[type="text"], select, textarea{
      width:100%; box-sizing:border-box;
      padding:8px 10px; border:1px solid #ccc; border-radius:10px;
      font:14px/1.2 system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    }
    textarea{ min-height:190px; resize:vertical; }
    .btns{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    button{
      padding:10px 12px; border:1px solid #111; border-radius:12px;
      background:#111; color:#fff; font-weight:700; cursor:pointer;
      flex:1; min-width:150px;
    }
    button.secondary{ background:#fff; color:#111; }
    .hint{
      font-size:12px; color:#555; margin-top:8px; line-height:1.35;
      background:#fafafa; border:1px solid #eee; border-radius:12px; padding:10px;
    }
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid #ddd; border-radius:12px; background:#fafafa;
    }
    .toggle input{ transform: scale(1.15); }
    .stage{ display:flex; justify-content:center; align-items:flex-start; padding:8px; position:relative; }
    .sheet{
      width: calc(297mm + (var(--bleed) * 2));
      height: calc(420mm + (var(--bleed) * 2));
      background: var(--bg);
      box-shadow: 0 10px 35px rgba(0,0,0,.25);
      position: relative; overflow: hidden;
      font-family: var(--font); font-weight: var(--fontWeight); color: var(--text);
    }
    .poster{
      position:absolute;
      top: var(--bleed); left: var(--bleed);
      width:297mm; height:420mm;
      box-sizing:border-box;
      padding:14mm;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:12mm;
    }
    .title{
      border: 5px solid var(--stroke);
      background: var(--titleBg);
      padding: 8mm 10mm;
      font-size: var(--titleSize);
      letter-spacing:2px;
      text-transform:uppercase;
      line-height:1;
      font-family: var(--font);
      font-weight: var(--fontWeight);
      color: var(--text);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      gap: var(--gap);
      align-content:start;
      font-family: var(--font);
      font-weight: var(--fontWeight);
    }
    .bubble{
      position:relative;
      background:var(--bubbleBg);
      border: 5px solid var(--stroke);
      border-radius: 14px;
      padding: 9mm;
      min-height: 40mm;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color: var(--text);
      font-size: var(--bubbleSize);
      line-height:1.15;
      letter-spacing: var(--letterSpacing);
      word-break: break-word;
      hyphens:auto;
    }
    .bubble > span{ display:block; width:100%; }
    .bubble::after{
      content:"";
      position:absolute;
      left:18mm;
      bottom:-14mm;
      border:14mm solid transparent;
      border-top-color: var(--stroke);
      border-bottom:0;
    }
    .bubble::before{
      content:"";
      position:absolute;
      left: calc(18mm + 2mm);
      bottom:-11mm;
      border:12mm solid transparent;
      border-top-color: var(--bubbleBg);
      border-bottom:0;
    }
    .tail-right::after{ left:auto; right:18mm; }
    .tail-right::before{ left:auto; right: calc(18mm + 2mm); }
    @media (max-width:1200px){
      body{ grid-template-columns:1fr; }
      .panel{ position:static; }
      .sheet{ transform:scale(.82); transform-origin: top center; }
    }
  </style>
</head>

<body>
  <aside class="panel" id="panel">
    <h2>Abfall-Sprüche-Editor</h2>

    <div class="toggle">
      <input type="checkbox" id="finalMode">
      <label for="finalMode" style="margin:0;font-size:13px;">Final Mode</label>
    </div>

    <h3>Text</h3>
    <div class="row">
      <div>
        <label for="titleText">Titel</label>
        <input id="titleText" type="text" value="PLASTIK-PARKPLATZ">
      </div>
      <div>
        <label for="cols">Spalten</label>
        <select id="cols">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
        </select>
      </div>
    </div>

    <div>
      <label for="lines">Sprüche (eine Zeile = eine Blase; weicher Umbruch in der Blase mit <b>|</b>)</label>
      <div class="rowAuto">
        <div style="font-size:12px;color:#666;align-self:center;">Cursor setzen →</div>
        <button type="button" class="secondary" id="insertPipe" style="min-width:auto;padding:8px 10px;">| einfügen</button>
      </div>
      <textarea id="lines"></textarea>
    </div>

    <h3>Von GitHub laden</h3>

    <div class="row">
      <div>
        <label for="jsonSelect">Auswahl (aus <code>manifest.json</code>)</label>
        <select id="jsonSelect">
          <option value="">(Manifest wird geladen…)</option>
        </select>
      </div>
      <div>
        <label for="jsonKind">Modus</label>
        <select id="jsonKind">
          <option value="auto" selected>Auto (empfohlen)</option>
          <option value="quotes">Sprüche</option>
          <option value="project">Projekt</option>
        </select>
      </div>
    </div>

    <div class="rowAuto">
      <div>
        <label for="jsonPath">Dateiname/URL (optional, überschreibt Auswahl)</label>
        <input id="jsonPath" type="text" placeholder="z.B. GIB_MIR_DEN_REST_1.json oder GitHub-Link">
      </div>
      <button type="button" class="secondary" id="loadJsonBtn" style="min-width:auto;padding:8px 10px;">Laden</button>
    </div>

    <div class="row">
      <div>
        <label for="jsonBase">Raw-Base (nur nötig bei <code>file://</code>)</label>
        <input id="jsonBase" type="text" placeholder="https://raw.githubusercontent.com/USER/REPO/main/">
      </div>
    </div>

    <div class="hint">
      Lege eine <b>manifest.json</b> neben die index.html.<br>
      Auto-Modus erkennt Sprüche (Array) oder Projekt-State (Objekt mit <code>titleText</code> + <code>lines</code>).
    </div>

    <h3>Projekt (lokal)</h3>
    <div class="btns">
      <button type="button" class="secondary" id="saveProject">Projekt speichern</button>
      <button type="button" class="secondary" id="loadProjectLocal">Projekt lokal laden</button>
      <input type="file" id="loadFile" accept="application/json" style="display:none">
    </div>

    <div class="btns">
      <button type="button" id="apply">Übernehmen</button>
      <button type="button" class="secondary" id="reset">Reset</button>
    </div>
  </aside>

  <main class="stage">
    <section class="sheet" id="sheet">
      <div class="poster">
        <div class="title" id="title">PLASTIK-PARKPLATZ</div>
        <div class="grid" id="grid"></div>
      </div>
    </section>
  </main>

  <script>
    const el = (id) => document.getElementById(id);
    const setVar = (name, value) => document.documentElement.style.setProperty(name, value);

    const STORAGE_KEY = "abfall_sprueche_state_v1";
    const JSON_BASE_KEY = "abfall_json_base_v1";

    const defaultLines = [
      "Nur Plastik hier | das danken wir dir.",
      "Plastik rein | die Welt soll sauber sein.",
      "Ich bin für jeden Verpackungsdreck | zu haben.",
      "Gelb ist fein | Plastik rein!"
    ];

    function escapeHtml(s){
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function renderBubbles(lines){
      const grid = el("grid");
      grid.innerHTML = "";
      const unique = [...new Set(lines.map(s => (s||"").trim()).filter(Boolean))];
      unique.forEach((text, i) => {
        const d = document.createElement("div");
        d.className = "bubble" + (i % 2 ? " tail-right" : "");
        const span = document.createElement("span");
        span.innerHTML = escapeHtml(text).replaceAll("|","<br>");
        d.appendChild(span);
        grid.appendChild(d);
      });
    }

    function getState(){
      return {
        titleText: el("titleText").value,
        lines: el("lines").value,
        cols: el("cols").value,
        finalMode: el("finalMode").checked
      };
    }

    function setState(state){
      if (!state || typeof state !== "object") return false;
      if (typeof state.lines !== "string" || typeof state.titleText !== "string") return false;
      el("titleText").value = state.titleText;
      el("lines").value = state.lines;
      el("cols").value = ["1","2","3","4"].includes(String(state.cols)) ? String(state.cols) : "3";
      el("finalMode").checked = !!state.finalMode;
      apply();
      return true;
    }

    function saveToLocal(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(getState())); }
      catch(e){ console.warn("Konnte nicht speichern:", e); }
    }

    function loadFromLocal(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        return setState(JSON.parse(raw));
      }catch(e){ return false; }
    }

    function apply(){
      el("title").textContent = (el("titleText").value || "").trim() || "TITEL";
      setVar("--cols", el("cols").value);
      renderBubbles(el("lines").value.split("\n"));
      saveToLocal();
    }

    function reset(){
      el("finalMode").checked = false;
      el("titleText").value = "PLASTIK-PARKPLATZ";
      el("cols").value = "3";
      el("lines").value = defaultLines.join("\n");
      apply();
    }

    function insertAtCursor(textarea, insertText){
      const start = textarea.selectionStart ?? textarea.value.length;
      const end = textarea.selectionEnd ?? textarea.value.length;
      textarea.setRangeText(insertText, start, end, "end");
      textarea.focus();
    }

    function downloadProject(){
      const data = JSON.stringify(getState(), null, 2);
      const blob = new Blob([data], {type:"application/json;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = (el("titleText").value || "projekt").replace(/[^\w\-]+/g, "_") + ".json";
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 1500);
    }

    // ---- GitHub helpers ----
    function normalizeBaseUrl(u){
      u = (u || "").trim();
      if (!u) return "";
      if (!u.endsWith("/")) u += "/";
      return u;
    }
    function setJsonBaseUrl(u){
      u = normalizeBaseUrl(u);
      if (!u) return;
      localStorage.setItem(JSON_BASE_KEY, u);
    }
    function getJsonBaseUrl(){
      const fromInput = el("jsonBase")?.value?.trim();
      if (fromInput) return normalizeBaseUrl(fromInput);
      const saved = localStorage.getItem(JSON_BASE_KEY);
      if (saved) return normalizeBaseUrl(saved);
      if (location.protocol !== "file:") return new URL(".", location.href).href;
      return "";
    }
    function toRawGitHubUrl(u){
      u = (u || "").trim();
      const m = u.match(/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/);
      if (m) return `https://raw.githubusercontent.com/${m[1]}/${m[2]}/${m[3]}/${m[4]}`;
      return u;
    }
    function guessGitHubRawBases(){
      try{
        if (!location.hostname.endsWith("github.io")) return [];
        const owner = location.hostname.split(".")[0];
        const parts = location.pathname.replace(/^\/+/, "").split("/");
        const repo = parts[0] || "";
        if (!owner || !repo) return [];
        return [
          `https://raw.githubusercontent.com/${owner}/${repo}/main/`,
          `https://raw.githubusercontent.com/${owner}/${repo}/master/`
        ];
      }catch(e){ return []; }
    }
    async function fetchJsonFirst(urls){
      let lastErr = null;
      for (const u of urls){
        if (!u) continue;
        try{
          const res = await fetch(u, {cache:"no-store"});
          if (!res.ok){ lastErr = new Error(res.status + " " + res.statusText); continue; }
          return await res.json();
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error("Fetch fehlgeschlagen");
    }
    function extractLinesFromJson(data){
      if (Array.isArray(data)) return data;
      if (data && typeof data === "object"){
        if (Array.isArray(data.lines)) return data.lines;
        if (Array.isArray(data.sprueche)) return data.sprueche;
        if (Array.isArray(data.items)) return data.items;
      }
      return null;
    }
    function looksLikeProjectState(data){
      return !!(data && typeof data === "object" && typeof data.titleText === "string" && typeof data.lines === "string");
    }

    async function loadFromJsonSmart(pathOrUrl, kind){
      const rawInput = (pathOrUrl || "").trim();
      if (!rawInput) throw new Error("Kein Dateiname/URL");

      const baseFromInput = el("jsonBase")?.value?.trim();
      if (baseFromInput) setJsonBaseUrl(baseFromInput);

      const here = new URL(".", location.href).href;
      let input = toRawGitHubUrl(rawInput);

      const candidates = [];
      const isAbsolute = /^https?:\/\//i.test(input);

      if (isAbsolute){
        candidates.push(input);
      } else {
        if (location.protocol !== "file:"){
          candidates.push(new URL(input, here).href);
        }
        const base = getJsonBaseUrl();
        if (base) candidates.push(new URL(input, base).href);
        guessGitHubRawBases().forEach(b => candidates.push(new URL(input, b).href));
      }

      const data = await fetchJsonFirst(candidates);

      if (kind === "quotes"){
        const lines = extractLinesFromJson(data);
        if (!lines) throw new Error("JSON ist keine Sprüche-Liste");
        el("lines").value = lines.map(s => String(s ?? "").trim()).filter(Boolean).join("\n");
        apply();
        return;
      }

      if (kind === "project"){
        if (!looksLikeProjectState(data)) throw new Error("JSON ist kein Projekt-State");
        if (!setState(data)) throw new Error("Projekt-State ungültig");
        return;
      }

      // auto
      const lines = extractLinesFromJson(data);
      if (lines){
        el("lines").value = lines.map(s => String(s ?? "").trim()).filter(Boolean).join("\n");
        apply();
        return;
      }
      if (looksLikeProjectState(data)){
        if (!setState(data)) throw new Error("Projekt-State ungültig");
        return;
      }
      throw new Error("Unbekanntes JSON-Format");
    }

    async function loadManifest(){
      try{
        const res = await fetch(new URL("manifest.json", new URL(".", location.href)).href, {cache:"no-store"});
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const data = await res.json();
        let files = Array.isArray(data) ? data : (Array.isArray(data.files) ? data.files : []);
        files = files.map(String).map(s => s.trim()).filter(Boolean);

        const sel = el("jsonSelect");
        sel.innerHTML = "";
        sel.appendChild(new Option("(Bitte auswählen…)", ""));
        for (const f of files){
          sel.appendChild(new Option(f.replace(/\.json$/i,""), f));
        }
        sel.appendChild(new Option("— Benutzerdefiniert… —", "__custom__"));
      }catch(e){
        const sel = el("jsonSelect");
        sel.innerHTML = "";
        sel.appendChild(new Option("(manifest.json nicht gefunden)", ""));
        sel.appendChild(new Option("— Benutzerdefiniert… —", "__custom__"));
      }
    }

    // Wire up
    el("apply").addEventListener("click", apply);
    el("reset").addEventListener("click", reset);
    el("insertPipe").addEventListener("click", () => { insertAtCursor(el("lines"), "|"); apply(); });

    el("saveProject").addEventListener("click", downloadProject);
    el("loadProjectLocal").addEventListener("click", () => el("loadFile").click());
    el("loadFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try{
        const text = await file.text();
        const state = JSON.parse(text);
        if (!setState(state)) throw new Error("invalid state");
        saveToLocal();
      }catch(err){
        alert("Datei konnte nicht geladen werden (kein gültiges JSON/State).");
      }finally{
        e.target.value = "";
      }
    });

    el("jsonSelect").addEventListener("change", () => {
      const v = el("jsonSelect").value;
      if (v === "__custom__") return;
      if (v) el("jsonPath").value = v;
    });

    el("loadJsonBtn").addEventListener("click", async () => {
      const typed = (el("jsonPath").value || "").trim();
      const picked = el("jsonSelect").value;
      const name = typed || (picked && picked !== "__custom__" ? picked : "");
      const kind = el("jsonKind").value;
      try{
        await loadFromJsonSmart(name, kind);
      }catch(err){
        alert("Konnte JSON nicht laden.\n\nEingabe: " + (name || "(leer)") + "\nDetails: " + (err?.message || err));
      }
    });

    try{
      const savedBase = localStorage.getItem(JSON_BASE_KEY);
      if (savedBase && el("jsonBase")) el("jsonBase").value = savedBase;
    }catch(e){}

    // Initial
    el("lines").value = defaultLines.join("\n");
    if (!loadFromLocal()) reset(); else apply();
    loadManifest();
  </script>
</body>
</html>
